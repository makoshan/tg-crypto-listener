# æ·±åº¦åˆ†æå¼•æ“åˆ‡æ¢æ–¹æ¡ˆ

## 1. ç›®æ ‡

å®ç°æ·±åº¦åˆ†æå¼•æ“åœ¨ **Claude** å’Œ **Gemini 2.5 Pro** ä¹‹é—´å¯é…ç½®åˆ‡æ¢ï¼Œä¸¤è€…å‡æ”¯æŒè®°å¿†ç®¡ç†ã€‚

## 2. å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¶ˆæ¯æ¥æ”¶å±‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä¸» AI åˆ†æï¼ˆGemini Flashï¼‰                      â”‚
â”‚          - å¿«é€Ÿåˆ†æ 90% æ¶ˆæ¯                             â”‚
â”‚          - åˆæ­¥ç½®ä¿¡åº¦è¯„ä¼°                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”œâ”€ confidence < 0.75 â”€â†’ è·³è¿‡æ·±åº¦åˆ†æ
                      â”‚
                      â–¼ confidence â‰¥ 0.75
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ·±åº¦åˆ†æï¼ˆClaude + Memory Toolï¼‰                â”‚
â”‚          - æ·±åº¦éªŒè¯ 10% é«˜ä»·å€¼ä¿¡å·                       â”‚
â”‚          - è®°å¿†ç®¡ç†ï¼ˆæŸ¥è¯¢/å­˜å‚¨å†å²æ¡ˆä¾‹ï¼‰                 â”‚
â”‚          - ç½®ä¿¡åº¦ä¿®æ­£                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è¾“å‡ºæœ€ç»ˆä¿¡å·                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. ç›®æ ‡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¶ˆæ¯æ¥æ”¶å±‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä¸» AI åˆ†æï¼ˆGemini Flashï¼‰                      â”‚
â”‚          - å¿«é€Ÿåˆ†æ 90% æ¶ˆæ¯                             â”‚
â”‚          - åˆæ­¥ç½®ä¿¡åº¦è¯„ä¼°                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”œâ”€ confidence < 0.75 â”€â†’ è·³è¿‡æ·±åº¦åˆ†æ
                      â”‚
                      â–¼ confidence â‰¥ 0.75
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ·±åº¦åˆ†æå¼•æ“æŠ½è±¡å±‚                              â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚          â”‚                â”‚                 â”‚          â”‚
â”‚          â–¼                â–¼                 â–¼          â”‚
â”‚   Claude Engine   Gemini 2.5 Pro    (æœªæ¥å¯æ‰©å±•)       â”‚
â”‚   + Memory Tool   + Function Call                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è¾“å‡ºæœ€ç»ˆä¿¡å·                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4. æ ¸å¿ƒè®¾è®¡

### 4.1 æ·±åº¦åˆ†æå¼•æ“æŠ½è±¡æ¥å£

```python
# src/ai/deep_analysis_engine.py

from abc import ABC, abstractmethod
from typing import Dict, Any
from .signal_engine import EventPayload, SignalResult

class DeepAnalysisEngine(ABC):
    """æ·±åº¦åˆ†æå¼•æ“æŠ½è±¡åŸºç±»"""

    @abstractmethod
    async def analyze(
        self,
        payload: EventPayload,
        initial_result: SignalResult
    ) -> SignalResult:
        """
        æ‰§è¡Œæ·±åº¦åˆ†æ

        Args:
            payload: åŸå§‹äº‹ä»¶æ•°æ®
            initial_result: ä¸» AI çš„åˆæ­¥åˆ†æç»“æœ

        Returns:
            ä¼˜åŒ–åçš„ä¿¡å·ç»“æœ
        """
        pass

    @abstractmethod
    def supports_memory(self) -> bool:
        """æ˜¯å¦æ”¯æŒè®°å¿†ç®¡ç†"""
        pass
```

### 4.2 Claude æ·±åº¦åˆ†æå¼•æ“å®ç°

```python
# src/ai/claude_deep_engine.py

from .deep_analysis_engine import DeepAnalysisEngine
from .anthropic_client import AnthropicClient
from ..memory import MemoryToolHandler

class ClaudeDeepAnalysisEngine(DeepAnalysisEngine):
    """Claude æ·±åº¦åˆ†æå¼•æ“ï¼ˆæ”¯æŒ Memory Toolï¼‰"""

    def __init__(
        self,
        client: AnthropicClient,
        memory_handler: MemoryToolHandler
    ):
        self._client = client
        self._memory_handler = memory_handler

    async def analyze(self, payload, initial_result):
        # æ„å»º Claude promptï¼ˆåŒ…å« Gemini åˆæ­¥ç»“æœï¼‰
        prompt = self._build_prompt(payload, initial_result)

        # è°ƒç”¨ Claudeï¼ˆè‡ªåŠ¨æ‰§è¡Œ Memory Tool å¾ªç¯ï¼‰
        response = await self._client.generate_signal(prompt)

        # è§£æå¹¶è¿”å›ç»“æœ
        return self._parse_response(response)

    def supports_memory(self) -> bool:
        return True
```

### 4.3 Gemini æ·±åº¦åˆ†æå¼•æ“å®ç°

```python
# src/ai/gemini_deep_engine.py

from .deep_analysis_engine import DeepAnalysisEngine
from .gemini_client import GeminiClient
from ..memory import MemoryToolHandler

class GeminiDeepAnalysisEngine(DeepAnalysisEngine):
    """Gemini 2.5 Pro æ·±åº¦åˆ†æå¼•æ“ï¼ˆæ”¯æŒ Function Callingï¼‰"""

    def __init__(
        self,
        client: GeminiClient,
        memory_handler: MemoryToolHandler,
        max_function_turns: int = 5
    ):
        self._client = client
        self._memory_handler = memory_handler
        self._max_turns = max_function_turns

    async def analyze(self, payload, initial_result):
        # æ„å»º Gemini prompt
        prompt = self._build_prompt(payload, initial_result)

        # æ‰§è¡Œ Function Calling å¾ªç¯
        response = await self._run_function_calling_loop(prompt)

        # è§£æå¹¶è¿”å›ç»“æœ
        return self._parse_response(response)

    async def _run_function_calling_loop(self, messages):
        """
        Gemini Function Calling å¾ªç¯

        ç±»ä¼¼ Claude çš„ Tool Use å¾ªç¯ï¼š
        1. è°ƒç”¨ Gemini APIï¼ˆå¸¦ tools å®šä¹‰ï¼‰
        2. æ£€æŸ¥æ˜¯å¦æœ‰ function_call
        3. æ‰§è¡Œ MemoryToolHandler
        4. å°†ç»“æœå›å¡«å¹¶ç»§ç»­è°ƒç”¨
        5. ç›´åˆ°æ²¡æœ‰ function_call æˆ–è¾¾åˆ°æœ€å¤§è½®æ•°
        """
        conversation_history = []
        turn_count = 0

        # å®šä¹‰ Memory Tool çš„ Gemini Function schema
        memory_tool_schema = self._build_memory_function_schema()

        while turn_count < self._max_turns:
            # è°ƒç”¨ Gemini API
            response = await self._client.generate_content(
                contents=messages + conversation_history,
                tools=[memory_tool_schema]
            )

            # æ£€æŸ¥æ˜¯å¦æœ‰ function_call
            function_calls = self._extract_function_calls(response)

            if not function_calls:
                # æ²¡æœ‰ function callï¼Œè¿”å›æœ€ç»ˆç»“æœ
                return response.text

            # æ‰§è¡Œæ‰€æœ‰ function calls
            for fc in function_calls:
                result = self._memory_handler.execute_tool_use(fc.args)

                # å›å¡« function response
                conversation_history.append({
                    "role": "function",
                    "name": fc.name,
                    "response": result
                })

            turn_count += 1

        raise RuntimeError("Function calling å¾ªç¯è¶…è¿‡æœ€å¤§è½®æ•°")

    def _build_memory_function_schema(self) -> Dict:
        """
        æ„å»º Gemini Function Calling schema

        å°† Claude Memory Tool schema è½¬æ¢ä¸º Gemini æ ¼å¼
        """
        return {
            "function_declarations": [
                {
                    "name": "memory",
                    "description": "Memory management tool for storing, retrieving, and modifying information",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "command": {
                                "type": "string",
                                "enum": ["view", "create", "str_replace", "insert", "delete", "rename"],
                                "description": "The command to execute"
                            },
                            "path": {
                                "type": "string",
                                "description": "File or directory path"
                            },
                            "file_text": {"type": "string"},
                            "old_str": {"type": "string"},
                            "new_str": {"type": "string"},
                            "insert_line": {"type": "integer"},
                            "insert_text": {"type": "string"},
                            "old_path": {"type": "string"},
                            "new_path": {"type": "string"}
                        },
                        "required": ["command"]
                    }
                }
            ]
        }

    def supports_memory(self) -> bool:
        return True
```

### 4.4 å·¥å‚æ¨¡å¼æ„å»ºå¼•æ“

```python
# src/ai/deep_analysis_factory.py

from typing import Optional
from .deep_analysis_engine import DeepAnalysisEngine
from .claude_deep_engine import ClaudeDeepAnalysisEngine
from .gemini_deep_engine import GeminiDeepAnalysisEngine
from .anthropic_client import AnthropicClient
from .gemini_client import GeminiClient
from ..memory import MemoryToolHandler

class DeepAnalysisEngineFactory:
    """æ·±åº¦åˆ†æå¼•æ“å·¥å‚"""

    @staticmethod
    def create(
        provider: str,
        config: Any,
        memory_handler: MemoryToolHandler
    ) -> Optional[DeepAnalysisEngine]:
        """
        åˆ›å»ºæ·±åº¦åˆ†æå¼•æ“

        Args:
            provider: 'claude' æˆ– 'gemini'
            config: é…ç½®å¯¹è±¡
            memory_handler: è®°å¿†ç®¡ç†å¤„ç†å™¨

        Returns:
            æ·±åº¦åˆ†æå¼•æ“å®ä¾‹ï¼Œå¤±è´¥è¿”å› None
        """
        provider = provider.lower().strip()

        if provider == "claude":
            return DeepAnalysisEngineFactory._create_claude_engine(
                config, memory_handler
            )
        elif provider == "gemini":
            return DeepAnalysisEngineFactory._create_gemini_engine(
                config, memory_handler
            )
        else:
            logger.warning(f"æœªçŸ¥çš„æ·±åº¦åˆ†æå¼•æ“: {provider}ï¼Œå°†ç¦ç”¨æ·±åº¦åˆ†æ")
            return None

    @staticmethod
    def _create_claude_engine(config, memory_handler):
        """åˆ›å»º Claude å¼•æ“"""
        api_key = getattr(config, "CLAUDE_API_KEY", "").strip()
        if not api_key:
            logger.warning("Claude API key æœªé…ç½®ï¼Œæ— æ³•å¯ç”¨ Claude æ·±åº¦åˆ†æ")
            return None

        try:
            client = AnthropicClient(
                api_key=api_key,
                model_name=getattr(config, "CLAUDE_MODEL", "claude-sonnet-4-5-20250929"),
                timeout=getattr(config, "CLAUDE_TIMEOUT_SECONDS", 30.0),
                max_tool_turns=getattr(config, "CLAUDE_MAX_TOOL_TURNS", 10),
                memory_handler=memory_handler,
            )
            logger.info("ğŸ§  Claude æ·±åº¦åˆ†æå¼•æ“å·²åˆå§‹åŒ–")
            return ClaudeDeepAnalysisEngine(client, memory_handler)
        except Exception as exc:
            logger.warning(f"Claude å¼•æ“åˆå§‹åŒ–å¤±è´¥: {exc}")
            return None

    @staticmethod
    def _create_gemini_engine(config, memory_handler):
        """åˆ›å»º Gemini å¼•æ“"""
        api_key = getattr(config, "GEMINI_API_KEY", "").strip()
        if not api_key:
            logger.warning("Gemini API key æœªé…ç½®ï¼Œæ— æ³•å¯ç”¨ Gemini æ·±åº¦åˆ†æ")
            return None

        try:
            client = GeminiClient(
                api_key=api_key,
                model_name=getattr(config, "GEMINI_DEEP_MODEL", "gemini-2.5-pro"),
                timeout=getattr(config, "GEMINI_DEEP_TIMEOUT_SECONDS", 30.0),
                max_retries=getattr(config, "GEMINI_DEEP_RETRY_ATTEMPTS", 1),
            )
            logger.info("ğŸ§  Gemini 2.5 Pro æ·±åº¦åˆ†æå¼•æ“å·²åˆå§‹åŒ–")
            return GeminiDeepAnalysisEngine(
                client,
                memory_handler,
                max_function_turns=getattr(config, "GEMINI_MAX_FUNCTION_TURNS", 5)
            )
        except Exception as exc:
            logger.warning(f"Gemini å¼•æ“åˆå§‹åŒ–å¤±è´¥: {exc}")
            return None
```

### 4.5 é›†æˆåˆ° AiSignalEngine

```python
# src/ai/signal_engine.py (ä¿®æ”¹éƒ¨åˆ†)

class AiSignalEngine:
    def __init__(
        self,
        enabled: bool,
        client: Optional[OpenAIChatClient],
        threshold: float,
        semaphore: asyncio.Semaphore,
        *,
        provider_label: str = "AI",
        deep_analysis_engine: Optional[DeepAnalysisEngine] = None,  # æ”¹ä¸ºæŠ½è±¡å¼•æ“
        high_value_threshold: float = 0.75,
    ):
        self.enabled = enabled and client is not None
        self._client = client
        self._threshold = threshold
        self._semaphore = semaphore
        self._provider_label = provider_label or "AI"
        self._deep_engine = deep_analysis_engine  # ç»Ÿä¸€æ¥å£
        self._high_value_threshold = high_value_threshold

        if self._deep_engine:
            engine_name = type(self._deep_engine).__name__
            logger.info(f"ğŸ¤– æ·±åº¦åˆ†æå¼•æ“å·²å¯ç”¨: {engine_name}")

    @classmethod
    def from_config(cls, config: Any) -> "AiSignalEngine":
        # ... åŸæœ‰ä¸» AI åˆå§‹åŒ–é€»è¾‘ ...

        # åˆå§‹åŒ–æ·±åº¦åˆ†æå¼•æ“ï¼ˆå¯åˆ‡æ¢ï¼‰
        deep_engine = None
        deep_enabled = getattr(config, "DEEP_ANALYSIS_ENABLED", False)
        if deep_enabled:
            provider = getattr(config, "DEEP_ANALYSIS_PROVIDER", "claude")
            memory_handler = MemoryToolHandler(
                base_path=getattr(config, "MEMORY_DIR", "./memories")
            )
            deep_engine = DeepAnalysisEngineFactory.create(
                provider, config, memory_handler
            )

        return cls(
            True,
            client,
            getattr(config, "AI_SIGNAL_THRESHOLD", 0.0),
            asyncio.Semaphore(concurrency),
            provider_label=provider_label,
            deep_analysis_engine=deep_engine,
            high_value_threshold=getattr(config, "HIGH_VALUE_CONFIDENCE_THRESHOLD", 0.75),
        )

    async def analyse(self, payload: EventPayload) -> SignalResult:
        # ... ä¸» AI åˆ†æé€»è¾‘ ...

        # æ·±åº¦åˆ†æï¼ˆç»Ÿä¸€æ¥å£ï¼‰
        if self._deep_engine and is_high_value:
            logger.info(f"ğŸ§  è§¦å‘æ·±åº¦åˆ†æ: {type(self._deep_engine).__name__}")
            try:
                deep_result = await self._deep_engine.analyze(payload, gemini_result)
                logger.info(f"âœ… æ·±åº¦åˆ†æå®Œæˆ: confidence={deep_result.confidence}")
                return deep_result
            except Exception as exc:
                logger.warning(f"âš ï¸ æ·±åº¦åˆ†æå¤±è´¥ï¼Œå›é€€åˆ°ä¸» AI ç»“æœ: {exc}")
                return gemini_result

        return gemini_result
```

## 5. é…ç½®å‚æ•°è®¾è®¡

### 5.1 æ–°å¢ç¯å¢ƒå˜é‡

```bash
# .env

# ========== æ·±åº¦åˆ†æå¼•æ“é…ç½® ==========
DEEP_ANALYSIS_ENABLED=true                    # æ˜¯å¦å¯ç”¨æ·±åº¦åˆ†æ
DEEP_ANALYSIS_PROVIDER=claude                 # æ·±åº¦åˆ†æå¼•æ“: claude | gemini
HIGH_VALUE_CONFIDENCE_THRESHOLD=0.75          # è§¦å‘æ·±åº¦åˆ†æçš„ç½®ä¿¡åº¦é˜ˆå€¼

# ========== Claude æ·±åº¦åˆ†æé…ç½® ==========
CLAUDE_ENABLED=true                           # å‘åå…¼å®¹ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ DEEP_ANALYSIS_PROVIDERï¼‰
CLAUDE_API_KEY=sk-ant-xxx
CLAUDE_MODEL=claude-sonnet-4-5-20250929
CLAUDE_TIMEOUT_SECONDS=30
CLAUDE_MAX_TOOL_TURNS=10

# ========== Gemini æ·±åº¦åˆ†æé…ç½® ==========
GEMINI_DEEP_MODEL=gemini-2.5-pro              # Gemini æ·±åº¦åˆ†ææ¨¡å‹
GEMINI_DEEP_TIMEOUT_SECONDS=30                # Gemini æ·±åº¦åˆ†æè¶…æ—¶æ—¶é—´
GEMINI_DEEP_RETRY_ATTEMPTS=1                  # Gemini æ·±åº¦åˆ†æé‡è¯•æ¬¡æ•°
GEMINI_MAX_FUNCTION_TURNS=5                   # Gemini Function Calling æœ€å¤§è½®æ•°

# ========== è®°å¿†ç®¡ç†é…ç½®ï¼ˆé€šç”¨ï¼‰==========
MEMORY_ENABLED=true
MEMORY_BACKEND=local                          # local | supabase | hybrid
MEMORY_DIR=./memories
```

### 5.2 é…ç½®ç±»æ›´æ–°

```python
# src/config.py (æ–°å¢éƒ¨åˆ†)

class Config:
    # ... åŸæœ‰é…ç½® ...

    # Deep Analysis Engine
    DEEP_ANALYSIS_ENABLED: bool = _as_bool(os.getenv("DEEP_ANALYSIS_ENABLED", "false"))
    DEEP_ANALYSIS_PROVIDER: str = os.getenv("DEEP_ANALYSIS_PROVIDER", "claude").lower()

    # Gemini Deep Analysis
    GEMINI_DEEP_MODEL: str = os.getenv("GEMINI_DEEP_MODEL", "gemini-2.5-pro")
    GEMINI_DEEP_TIMEOUT_SECONDS: float = float(os.getenv("GEMINI_DEEP_TIMEOUT_SECONDS", "30"))
    GEMINI_DEEP_RETRY_ATTEMPTS: int = int(os.getenv("GEMINI_DEEP_RETRY_ATTEMPTS", "1"))
    GEMINI_MAX_FUNCTION_TURNS: int = int(os.getenv("GEMINI_MAX_FUNCTION_TURNS", "5"))
```

## 6. Gemini Function Calling æŠ€æœ¯ç»†èŠ‚

### 6.1 Gemini SDK ç¤ºä¾‹

```python
import google.generativeai as genai

# é…ç½® API Key
genai.configure(api_key="YOUR_API_KEY")

# å®šä¹‰ Function Declaration
memory_tool = genai.protos.Tool(
    function_declarations=[
        genai.protos.FunctionDeclaration(
            name="memory",
            description="Memory management tool",
            parameters=genai.protos.Schema(
                type=genai.protos.Type.OBJECT,
                properties={
                    "command": genai.protos.Schema(type=genai.protos.Type.STRING),
                    "path": genai.protos.Schema(type=genai.protos.Type.STRING),
                    # ... å…¶ä»–å‚æ•°
                },
                required=["command"]
            )
        )
    ]
)

# è°ƒç”¨æ¨¡å‹
model = genai.GenerativeModel("gemini-2.5-pro", tools=[memory_tool])
chat = model.start_chat()

response = chat.send_message("è¯·æŸ¥çœ‹è®°å¿†ä¸­çš„ BTC å†å²æ¡ˆä¾‹")

# æ£€æŸ¥æ˜¯å¦æœ‰ function call
if response.candidates[0].content.parts[0].function_call:
    fc = response.candidates[0].content.parts[0].function_call

    # æ‰§è¡Œ function
    result = execute_memory_tool(fc.args)

    # å›å¡«ç»“æœ
    response = chat.send_message(
        genai.protos.Content(
            parts=[genai.protos.Part(
                function_response=genai.protos.FunctionResponse(
                    name=fc.name,
                    response={"result": result}
                )
            )]
        )
    )
```

### 6.2 å…³é”®å·®å¼‚å¯¹æ¯”

| ç‰¹æ€§ | Claude Memory Tool | Gemini Function Calling |
|------|-------------------|------------------------|
| API å‚æ•° | `tools=[{type: "custom", ...}]` | `tools=[genai.protos.Tool(...)]` |
| è¯·æ±‚æ ¼å¼ | `messages` åˆ—è¡¨ | `contents` åˆ—è¡¨ |
| å“åº”æ ¼å¼ | `ToolUseBlock` | `FunctionCall` |
| å›å¡«æ ¼å¼ | `tool_result` | `function_response` |
| å¾ªç¯æ§åˆ¶ | `stop_reason` | æ£€æŸ¥ `function_call` æ˜¯å¦å­˜åœ¨ |

## 7. å®æ–½æ­¥éª¤

### Phase 1: åŸºç¡€æ¶æ„ï¼ˆ1-2 å¤©ï¼‰
1. âœ… åˆ›å»ºæŠ½è±¡åŸºç±» `DeepAnalysisEngine`
2. âœ… é‡æ„ç°æœ‰ Claude å®ç°ä¸º `ClaudeDeepAnalysisEngine`
3. âœ… åˆ›å»ºå·¥å‚ç±» `DeepAnalysisEngineFactory`
4. âœ… æ›´æ–° `AiSignalEngine` é›†æˆæŠ½è±¡å¼•æ“

### Phase 2: Gemini å®ç°ï¼ˆ2-3 å¤©ï¼‰
1. âœ… å®ç° `GeminiDeepAnalysisEngine`
2. âœ… å®ç° Gemini Function Calling å¾ªç¯
3. âœ… è½¬æ¢ Memory Tool schema åˆ° Gemini æ ¼å¼
4. âœ… æµ‹è¯• Function Calling åŸºæœ¬æµç¨‹

### Phase 3: é…ç½®å’Œæµ‹è¯•ï¼ˆ1-2 å¤©ï¼‰
1. âœ… æ·»åŠ é…ç½®å‚æ•°
2. âœ… ç¼–å†™å•å…ƒæµ‹è¯•
3. âœ… ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆClaude æ¨¡å¼ï¼‰
4. âœ… ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆGemini æ¨¡å¼ï¼‰

### Phase 4: æ–‡æ¡£å’Œä¼˜åŒ–ï¼ˆ1 å¤©ï¼‰
1. âœ… æ›´æ–° README
2. âœ… ç¼–å†™åˆ‡æ¢æŒ‡å—
3. âœ… æ€§èƒ½å¯¹æ¯”åˆ†æ
4. âœ… æˆæœ¬å¯¹æ¯”åˆ†æ

## 8. ä¼˜ç¼ºç‚¹å¯¹æ¯”

### Claude æ·±åº¦åˆ†æå¼•æ“

**ä¼˜ç‚¹**ï¼š
- âœ… Memory Tool åŸç”Ÿæ”¯æŒï¼ˆå®˜æ–¹ SDKï¼‰
- âœ… ä¸Šä¸‹æ–‡ç†è§£èƒ½åŠ›å¼º
- âœ… æˆç†Ÿç¨³å®šï¼ˆå·²éªŒè¯ï¼‰
- âœ… æ”¯æŒ Context Editingï¼ˆè‡ªåŠ¨æ¸…ç†æ—§ Tool Useï¼‰

**ç¼ºç‚¹**ï¼š
- âŒ æˆæœ¬è¾ƒé«˜ï¼ˆ$3/MTok input, $15/MTok outputï¼‰
- âŒ è¯·æ±‚é¢‘ç‡é™åˆ¶
- âŒ è°ƒç”¨é€Ÿåº¦è¾ƒæ…¢ï¼ˆ20-30sï¼‰

### Gemini 2.5 Pro æ·±åº¦åˆ†æå¼•æ“

**ä¼˜ç‚¹**ï¼š
- âœ… æˆæœ¬æ›´ä½ï¼ˆ$1.25/MTok input, $5/MTok outputï¼Œä»… Claude 1/3ï¼‰
- âœ… è°ƒç”¨é€Ÿåº¦å¿«ï¼ˆ10-15sï¼‰
- âœ… ä¸ä¸» AI åŒä¸€ç”Ÿæ€ï¼ˆæ›´å¥½çš„æ ¼å¼ä¸€è‡´æ€§ï¼‰
- âœ… æ”¯æŒå¤šæ¨¡æ€ï¼ˆå¯ç›´æ¥åˆ†æå›¾ç‰‡ï¼‰

**ç¼ºç‚¹**ï¼š
- âŒ Function Calling éœ€è¦æ‰‹åŠ¨å®ç°å¾ªç¯
- âŒ æ·±åº¦æ¨ç†èƒ½åŠ›ç•¥å¼±äº Claude
- âŒ ç¼ºå°‘ Context Editingï¼ˆéœ€æ‰‹åŠ¨ç®¡ç†ä¸Šä¸‹æ–‡ï¼‰

## 9. æ¨èé…ç½®

### 9.1 æˆæœ¬ä¼˜å…ˆï¼ˆæ¨èï¼‰

```bash
DEEP_ANALYSIS_ENABLED=true
DEEP_ANALYSIS_PROVIDER=gemini
GEMINI_DEEP_MODEL=gemini-2.5-pro
HIGH_VALUE_CONFIDENCE_THRESHOLD=0.75
```

**é€‚ç”¨åœºæ™¯**ï¼š
- é¢„ç®—æœ‰é™
- æ¶ˆæ¯é‡å¤§ï¼ˆæ¯å¤© > 100 æ¡é«˜ä»·å€¼ä¿¡å·ï¼‰
- å¯¹å»¶è¿Ÿæ•æ„Ÿ

**é¢„ä¼°æˆæœ¬**ï¼šçº¦ Claude çš„ 30%

### 9.2 è´¨é‡ä¼˜å…ˆ

```bash
DEEP_ANALYSIS_ENABLED=true
DEEP_ANALYSIS_PROVIDER=claude
CLAUDE_MODEL=claude-sonnet-4-5-20250929
HIGH_VALUE_CONFIDENCE_THRESHOLD=0.80
```

**é€‚ç”¨åœºæ™¯**ï¼š
- é¢„ç®—å……è¶³
- å¯¹åˆ†æè´¨é‡è¦æ±‚æé«˜
- æ¶ˆæ¯é‡é€‚ä¸­ï¼ˆæ¯å¤© < 50 æ¡é«˜ä»·å€¼ä¿¡å·ï¼‰

**é¢„ä¼°æˆæœ¬**ï¼šåŸºå‡†

### 9.3 æ··åˆæ¨¡å¼ï¼ˆæœªæ¥æ‰©å±•ï¼‰

å¯åœ¨å·¥å‚ç±»ä¸­å®ç°æ™ºèƒ½è·¯ç”±ï¼š
- ç®€å•äº‹ä»¶ï¼ˆlistingã€delistingï¼‰ â†’ Gemini
- å¤æ‚äº‹ä»¶ï¼ˆregulationã€hackï¼‰ â†’ Claude

## 10. ç›‘æ§æŒ‡æ ‡

å»ºè®®æ·»åŠ ä»¥ä¸‹ç›‘æ§ï¼š

```python
# æ·±åº¦åˆ†æå¼•æ“æ€§èƒ½æŒ‡æ ‡
metrics = {
    "deep_analysis_engine": "claude | gemini",
    "deep_analysis_calls_total": 0,
    "deep_analysis_success_rate": 0.0,
    "deep_analysis_avg_latency": 0.0,
    "memory_tool_calls_total": 0,
    "function_calling_loops_avg": 0.0,
    "cost_per_analysis": 0.0
}
```

## 11. é£é™©å’Œç¼“è§£

### é£é™© 1: Gemini Function Calling ä¸ç¨³å®š

**ç¼“è§£**ï¼š
- è®¾ç½® `max_function_turns` é˜²æ­¢æ­»å¾ªç¯
- æ·»åŠ è¯¦ç»†æ—¥å¿—è¿½è¸ªæ¯è½®è°ƒç”¨
- è‡ªåŠ¨å›é€€åˆ° Claudeï¼ˆé…ç½® fallbackï¼‰

### é£é™© 2: ä¸¤ç§å¼•æ“è¾“å‡ºæ ¼å¼ä¸ä¸€è‡´

**ç¼“è§£**ï¼š
- ä½¿ç”¨ç»Ÿä¸€çš„ Prompt æ¨¡æ¿
- ç»Ÿä¸€çš„ JSON Schema éªŒè¯
- åœ¨ `_parse_response` ä¸­æ ‡å‡†åŒ–è¾“å‡º

### é£é™© 3: è®°å¿†ç®¡ç†è¡Œä¸ºå·®å¼‚

**ç¼“è§£**ï¼š
- `MemoryToolHandler` æ˜¯é€šç”¨å®ç°ï¼Œè¡Œä¸ºä¸€è‡´
- åªæœ‰è°ƒç”¨æ–¹å¼ä¸åŒï¼ˆTool Use vs Function Callï¼‰
- ç¼–å†™é›†æˆæµ‹è¯•ç¡®ä¿ä¸€è‡´æ€§

## 12. åç»­ä¼˜åŒ–æ–¹å‘

1. **è‡ªåŠ¨åŒ– A/B æµ‹è¯•**ï¼šåŒæ—¶è¿è¡Œä¸¤ä¸ªå¼•æ“ï¼Œæ¯”è¾ƒç»“æœ
2. **æ™ºèƒ½è·¯ç”±**ï¼šæ ¹æ®äº‹ä»¶ç±»å‹è‡ªåŠ¨é€‰æ‹©å¼•æ“
3. **æ··åˆéªŒè¯**ï¼šå…³é”®ä¿¡å·åŒæ—¶è°ƒç”¨ä¸¤ä¸ªå¼•æ“äº¤å‰éªŒè¯
4. **æˆæœ¬ä¼˜åŒ–**ï¼šåŠ¨æ€è°ƒæ•´è§¦å‘é˜ˆå€¼ï¼ˆGemini å¯é™ä½åˆ° 0.65ï¼‰
5. **Gemini Context Caching**ï¼šåˆ©ç”¨ Gemini çš„ context caching é™ä½æˆæœ¬

---

**æ€»ç»“**ï¼šè¯¥æ–¹æ¡ˆé€šè¿‡æŠ½è±¡å±‚å®ç°æ·±åº¦åˆ†æå¼•æ“çš„çµæ´»åˆ‡æ¢ï¼Œæ—¢ä¿æŒäº† Claude çš„é«˜è´¨é‡åˆ†æèƒ½åŠ›ï¼Œåˆæä¾›äº† Gemini çš„ä½æˆæœ¬é€‰é¡¹ï¼Œç”¨æˆ·å¯æ ¹æ®å®é™…éœ€æ±‚è‡ªç”±é…ç½®ã€‚
