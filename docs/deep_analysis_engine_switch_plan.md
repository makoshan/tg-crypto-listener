# 深度分析引擎一体化方案

本方案整合了原有的切换规划与实施细节，提供单一文档指导如何在 Claude 与 Gemini 2.5 Pro 之间灵活切换深度分析引擎，同时保护记忆能力与现有业务流程。

## 1. 背景与目标
- 维持主分析（Gemini Flash）的高速初筛能力，仅将高置信度/高价值信号交给深度分析。
- 通过引擎抽象层在 Claude 与 Gemini 2.5 Pro 间平滑切换，实现成本、质量与延迟的可配置权衡。
- 让记忆模块对两种引擎保持一致体验，避免重复实现。

## 2. 角色定位与关键能力
- **主分析层**：负责 90% 的日常消息，输出初步置信度；当置信度 ≥ 阈值时触发深度分析。
- **深度分析层**：执行验证、补充上下文、调用记忆，并最终修正置信度。支持 Claude Tool Use 与 Gemini Function Calling。
- **记忆子系统**：统一封装 Supabase、本地或其他后端，供深度分析引擎透明地读写。

## 3. 当前与目标架构

### 3.1 现状（单一 Claude 深度分析）
```
┌─────────────────────────────────────────────────────────┐
│                    消息接收层                            │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│          主 AI 分析（Gemini Flash）                      │
│          - 快速分析 90% 消息                             │
│          - 初步置信度评估                                │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ├─ confidence < 0.75 ─→ 跳过深度分析
                      │
                      ▼ confidence ≥ 0.75
┌─────────────────────────────────────────────────────────┐
│          深度分析（Claude + Memory Tool）                │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│                   输出最终信号                           │
└─────────────────────────────────────────────────────────┘
```

### 3.2 目标（抽象化深度引擎）
```
┌─────────────────────────────────────────────────────────┐
│                    消息接收层                            │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│          主 AI 分析（Gemini Flash）                      │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ├─ confidence < 阈值 ─→ 跳过深度分析
                      │
                      ▼ confidence ≥ 阈值
┌─────────────────────────────────────────────────────────┐
│          深度分析引擎抽象层                              │
│          ┌────────────────┬─────────────────┐          │
│          │                │                 │          │
│          ▼                ▼                 ▼          │
│   Claude Engine   Gemini 2.5 Pro    后续可扩展入口      │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│                   输出最终信号                           │
└─────────────────────────────────────────────────────────┘
```

## 4. 核心设计原则
- **抽象优先**：深度引擎通过工厂模式创建，统一的请求/响应结构与错误处理确保新引擎可插拔。
- **记忆共享**：统一的 `MemoryToolHandler` 与 `create_memory_backend` 抽象保证任意引擎调用记忆时行为一致。
- **Prompt 复用**：在基类定义 prompt 模板与结果解析，避免针对不同引擎维护两套文稿。
- **上下文控制**：提供通用的上下文裁剪策略（示例：prune 旧消息、限制工具回合数）以防 token 爆炸。
- **配置向后兼容**：保留 `CLAUDE_ENABLED` 旧配置同时推荐使用 `DEEP_ANALYSIS_*` 新变量。

## 5. 关键交付项（按业务能力组织）
1. **深度引擎抽象层**  
   - 提供启动、执行、响应解析的统一接口。  
   - 支持热插拔不同模型，并对外暴露统一的统计信息。
2. **Gemini Function Calling 支持**  
   - 独立客户端封装工具声明、轮询会话、错误重试与超时。  
   - 约束最大函数调用轮数、异常回退策略。
3. **Claude Tool Use 对齐**  
   - 重用现有 Memory Tool 逻辑，同时在抽象层内统一日志、超时与重试。  
   - 确保 Claude 与 Gemini 共享同样的 prompt 和输出 schema。
4. **记忆后端工厂**  
   - 在加载阶段根据配置选择 Supabase、本地或其他实现，输出统一接口。  
   - 支持扩展新的后端时零改动深度引擎。
5. **上下文管理策略**  
   - 建立通用的消息裁剪、摘要与工具调用清理策略。  
   - 在 Gemini 中限制 Function 回合，针对 Claude 保留 Context Editing。
6. **配置与迁移体验**  
   - 增加 `Config.get_deep_analysis_config()` 等辅助方法，屏蔽旧变量。  
   - 提供环境变量优先级表与推荐组合。
7. **测试与监控基线**  
   - 集成测试覆盖 Claude/Gemini 端到端流程。  
   - 统一 metrics 字段（调用量、成功率、延迟、成本）。

## 6. 实施路径
- **Phase 0：准备**  
  评估 API 配额、准备记忆后端凭据、确认日志与指标出口。
- **Phase 1：基础设施**  
  实现深度引擎基类、工厂、配置读取；创建 Gemini Function 客户端；抽象记忆后端。
- **Phase 2：引擎适配**  
  接入 Claude 与 Gemini，统一 prompt / schema，完成上下文裁剪、重试策略与 fallback。  
  梳理日志格式和错误分类，确保链路可观测。
- **Phase 3：集成与回归**  
  在 `AiSignalEngine` 中启用新抽象；编写 Gemini 端到端测试；复用现有 Claude 测试；验证记忆写入/读取。  
  对比关键指标（成功率、平均时延、token 消耗）。
- **Phase 4：发布与文档*  
  更新 README 与操作指南；输出切换手册，完成成本/性能对比，准备回滚策略。

## 7. 配置策略与迁移
- 推荐新的主开关为 `DEEP_ANALYSIS_ENABLED` 与 `DEEP_ANALYSIS_PROVIDER`，默认回退到旧的 `CLAUDE_ENABLED` 防止现有部署中断。
- 当旧变量与新变量同时存在时，以新变量优先；并在日志中提示迁移。
- 环境变量组合示例：  
  - 成本优先：`DEEP_ANALYSIS_ENABLED=true`，`DEEP_ANALYSIS_PROVIDER=gemini`，`GEMINI_DEEP_MODEL=gemini-2.5-pro`。  
  - 质量优先：`DEEP_ANALYSIS_ENABLED=true`，`DEEP_ANALYSIS_PROVIDER=claude`，`CLAUDE_MODEL=claude-sonnet-4.5`。  
  - 深度分析关闭：不设置或显式 `DEEP_ANALYSIS_ENABLED=false`。
- 为每个组合记录警告策略，例如仅设置旧变量时提示即将废弃。

## 8. 监控、测试与验收
- 统一指标：深度分析引擎类型、调用次数、成功率、平均延迟、记忆读写次数、平均 Function 回合数、单次成本估算。
- 测试矩阵：  
  - 单元测试覆盖工厂、配置解析、上下文裁剪逻辑。  
  - 集成测试验证 Claude/Gemini 在真实消息上输出一致结构。  
  - 性能测试对比长上下文与高并发场景的行为，确保无死循环或超时。
- 验收标准：在 sandbox 与生产影子环境中跑通 24 小时监控，关键指标满足基线；深度分析结果格式稳定。

## 9. 风险与缓解
- **Function Calling 不稳定**：限制最大回合并收集细粒度日志，必要时自动回退至 Claude。  
- **输出格式不一致**：所有响应经统一解析器，落地前使用 JSON Schema 校验。  
- **记忆行为差异**：通过共享的记忆 handler 来隔离差异，并以集成测试验证一致性。  
- **上下文失控**：实施上下文裁剪与超时控制，持续监控 token 消耗。

## 10. 推荐运行模式
- 成本敏感：首选 Gemini 深度分析，将置信度阈值下调至 0.75 左右以覆盖更多场景。  
- 质量优先：启用 Claude，必要时提升置信度阈值到 0.80，并保留 Gemini 作为备用引擎。  
- 混合与未来扩展：基于事件类型或置信度趋势做动态路由，或并行调用双引擎进行交叉验证。

## 11. 后续优化方向
- 自动化 A/B 测试与智能路由策略。  
- 持续优化 Gemini 上下文缓存以降低成本。  
- 引擎健康监控仪表盘与告警策略。  
- 对记忆后端进行分层缓存或批量操作，提升高频调用表现。