# ç«‹å³å»é‡æœºåˆ¶ï¼ˆè§£å†³ä¸€ç§’å†…é‡å¤é—®é¢˜ï¼‰

## é—®é¢˜æè¿°

åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒåŒä¸€ Telegram æ¶ˆæ¯å¯èƒ½åœ¨æçŸ­æ—¶é—´å†…ï¼ˆ1 ç§’å†…ï¼‰è¢«å¤šæ¬¡è§¦å‘å¤„ç†ï¼Œå¯¼è‡´é‡å¤è½¬å‘ã€‚è¿™å¯èƒ½ç”±ä»¥ä¸‹åŸå› å¯¼è‡´ï¼š

1. Telegram API çš„é‡å¤äº‹ä»¶è§¦å‘
2. ç½‘ç»œé‡ä¼ å¯¼è‡´çš„é‡å¤æ¥æ”¶
3. æ¶ˆæ¯è¢«å¤šä¸ªç›‘å¬å™¨åŒæ—¶å¤„ç†

## è§£å†³æ–¹æ¡ˆ

æ–°å¢äº† **åŸºäºæ¶ˆæ¯IDçš„ç«‹å³å»é‡æœºåˆ¶** (`MessageIdDeduplicator`)ï¼Œåœ¨æ‰€æœ‰å…¶ä»–å¤„ç†ä¹‹å‰ç«‹å³æ£€æŸ¥å¹¶è®°å½•æ¶ˆæ¯IDï¼Œé˜²æ­¢åŒä¸€æ¡æ¶ˆæ¯è¢«å¤šæ¬¡å¤„ç†ã€‚

### å·¥ä½œåŸç†

1. **ç«‹å³æ£€æŸ¥**: åœ¨æ”¶åˆ°æ¶ˆæ¯çš„ç¬¬ä¸€æ—¶é—´ï¼ŒåŸºäº `(é¢‘é“ID, æ¶ˆæ¯ID)` çš„ç»„åˆè¿›è¡Œæ£€æŸ¥
2. **å³æ—¶è®°å½•**: å¦‚æœæ¶ˆæ¯æœªè¢«å¤„ç†è¿‡ï¼Œç«‹å³è®°å½•åˆ°å†…å­˜ä¸­ï¼ˆé˜²æ­¢ç«æ€æ¡ä»¶ï¼‰
3. **æ—¶é—´çª—å£**: ä¿ç•™æœ€è¿‘ 60 åˆ†é’Ÿçš„æ¶ˆæ¯IDè®°å½•ï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ¡ç›®

### å»é‡å±‚æ¬¡ï¼ˆç°åœ¨å…± 5 å±‚ï¼‰

1. **æ¶ˆæ¯IDå»é‡** âœ¨ **ï¼ˆæ–°å¢ï¼Œç«‹å³ç”Ÿæ•ˆï¼‰**
   - åŸºäº `(é¢‘é“ID, æ¶ˆæ¯ID)` çš„ç»„åˆ
   - çª—å£ï¼š60 åˆ†é’Ÿï¼ˆå†…å­˜æ¸…ç†çª—å£ï¼‰
   - **è¿™æ˜¯æœ€å¿«çš„æ£€æŸ¥ï¼Œåœ¨æ¶ˆæ¯å¤„ç†çš„ç¬¬ä¸€æ—¶é—´å°±è¿›è¡Œ**

2. **å†…å­˜çª—å£å»é‡** (`MessageDeduplicator`)
   - åŸºäºæ¶ˆæ¯æ–‡æœ¬çš„ MD5 å“ˆå¸Œ
   - çª—å£ï¼š4 å°æ—¶ï¼ˆ`DEDUP_WINDOW_HOURS`ï¼‰

3. **æ•°æ®åº“å“ˆå¸Œå»é‡**
   - åŸºäº `SHA256(æ¶ˆæ¯æ–‡æœ¬)` æ£€æŸ¥æ•°æ®åº“

4. **è¯­ä¹‰å‘é‡å»é‡**
   - åŸºäº embedding çš„è¯­ä¹‰ç›¸ä¼¼åº¦æ£€æŸ¥
   - çª—å£ï¼š72 å°æ—¶ï¼ˆ`EMBEDDING_TIME_WINDOW_HOURS`ï¼‰

5. **ä¿¡å·çº§åˆ«å»é‡** (`SignalMessageDeduplicator`)
   - åŸºäº AI ç”Ÿæˆä¿¡å·çš„ç›¸ä¼¼åº¦
   - çª—å£ï¼š4 å°æ—¶ï¼ˆ`SIGNAL_DEDUP_WINDOW_MINUTES=240`ï¼‰

## å®ç°ç»†èŠ‚

### MessageIdDeduplicator ç±»

**ä½ç½®**: `src/utils.py:137-180`

```python
class MessageIdDeduplicator:
    """Immediate deduplication by message ID + channel ID."""
    
    def is_duplicate(self, channel_id: str, message_id: str) -> bool:
        """Return True if this message ID from this channel was seen recently."""
        # æ£€æŸ¥å¹¶ç«‹å³è®°å½•ï¼Œé˜²æ­¢ç«æ€æ¡ä»¶
        key = (str(channel_id), str(message_id))
        if key in self.seen_message_ids:
            return True
        self.seen_message_ids[key] = datetime.now()
        return False
```

### é›†æˆç‚¹

**ä½ç½®**: `src/listener.py:328-340`

åœ¨ `_handle_new_message` æ–¹æ³•çš„å¼€å§‹å¤„ç«‹å³è¿›è¡Œæ£€æŸ¥ï¼Œæ— è®ºæ˜¯ä½¿ç”¨ LangGraph pipeline è¿˜æ˜¯ä¼ ç»Ÿæµç¨‹ï¼Œéƒ½ä¼šå…ˆè¿›è¡Œæ¶ˆæ¯IDå»é‡ï¼š

```python
async def _handle_new_message(self, event) -> None:
    # ç«‹å³æ¶ˆæ¯IDå»é‡ï¼ˆé˜²æ­¢1ç§’å†…é‡å¤ï¼‰
    source_chat = await event.get_chat()
    source_message_id = str(getattr(event.message, "id", ""))
    channel_id = str(getattr(source_chat, "id", "")) or getattr(source_chat, "username", None)
    
    if source_message_id and self.message_id_deduplicator.is_duplicate(channel_id, source_message_id):
        self.stats["duplicates"] += 1
        self.stats["dup_message_id"] += 1
        logger.debug("ğŸ”„ æ¶ˆæ¯IDé‡å¤ï¼Œå·²è·³è¿‡")
        return
    
    # ç»§ç»­å¤„ç†ï¼ˆLangGraph æˆ–ä¼ ç»Ÿæµç¨‹ï¼‰
    ...
```

## ç»Ÿè®¡ä¿¡æ¯

è¿è¡Œç»Ÿè®¡ä¸­ä¼šæ˜¾ç¤ºæ¶ˆæ¯IDå»é‡çš„æ•°é‡ï¼š

```
ğŸ“Š **è¿è¡Œç»Ÿè®¡**
   â€¢ é‡å¤æ¶ˆæ¯: X (æ¶ˆæ¯ID: Y / å†…å­˜: Z / å“ˆå¸Œ: A / è¯­ä¹‰: B / ä¿¡å·: C)
```

å…¶ä¸­ï¼š
- **æ¶ˆæ¯ID**: åŸºäºæ¶ˆæ¯IDå»é‡çš„æ•°é‡ï¼ˆæ–°å¢ï¼‰
- **å†…å­˜**: åŸºäºæ–‡æœ¬å“ˆå¸Œçš„å†…å­˜å»é‡
- **å“ˆå¸Œ**: æ•°æ®åº“å“ˆå¸Œå»é‡
- **è¯­ä¹‰**: è¯­ä¹‰å‘é‡å»é‡
- **ä¿¡å·**: AI ä¿¡å·å»é‡

## é…ç½®

å½“å‰å®ç°ä½¿ç”¨å›ºå®šé…ç½®ï¼š
- **æ—¶é—´çª—å£**: 60 åˆ†é’Ÿï¼ˆç”¨äºå†…å­˜æ¸…ç†ï¼‰
- **æ£€æŸ¥æ—¶æœº**: æ¶ˆæ¯å¤„ç†çš„ç¬¬ä¸€æ—¶é—´ï¼ˆåœ¨ä»»ä½•å…¶ä»–å¤„ç†ä¹‹å‰ï¼‰

å¦‚æœéœ€è¦è°ƒæ•´çª—å£å¤§å°ï¼Œå¯ä»¥ä¿®æ”¹ `src/listener.py:61`:

```python
self.message_id_deduplicator = MessageIdDeduplicator(window_minutes=60)  # å¯è°ƒæ•´
```

## ä¼˜åŠ¿

1. **é›¶å»¶è¿Ÿ**: åœ¨æ¶ˆæ¯å¤„ç†çš„ç¬¬ä¸€æ—¶é—´å°±è¿›è¡Œæ£€æŸ¥ï¼Œæ— éœ€ç­‰å¾…ä»»ä½•å¼‚æ­¥æ“ä½œ
2. **é˜²ç«æ€**: æ£€æŸ¥åç«‹å³è®°å½•ï¼Œé¿å…å¹¶å‘å¤„ç†åŒä¸€æ¡æ¶ˆæ¯
3. **å†…å­˜é«˜æ•ˆ**: åªä¿ç•™æœ€è¿‘ 60 åˆ†é’Ÿçš„è®°å½•ï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ¡ç›®
4. **å…¼å®¹æ€§å¥½**: æ— è®ºæ˜¯ LangGraph pipeline è¿˜æ˜¯ä¼ ç»Ÿæµç¨‹éƒ½èƒ½ç”Ÿæ•ˆ

## æ•…éšœæ’æŸ¥

å¦‚æœä»ç„¶å‡ºç°ä¸€ç§’å†…é‡å¤ï¼š

1. **æ£€æŸ¥æ—¥å¿—**: æŸ¥çœ‹æ˜¯å¦æœ‰ `ğŸ”„ æ¶ˆæ¯IDé‡å¤ï¼Œå·²è·³è¿‡` çš„æ—¥å¿—
2. **éªŒè¯ç»Ÿè®¡**: æŸ¥çœ‹ `dup_message_id` ç»Ÿè®¡æ˜¯å¦æœ‰å¢åŠ 
3. **æ£€æŸ¥æ¶ˆæ¯ID**: ç¡®è®¤æ¶ˆæ¯æ˜¯å¦æœ‰æœ‰æ•ˆçš„ `message.id`
4. **æ£€æŸ¥é¢‘é“ID**: ç¡®è®¤é¢‘é“æ ‡è¯†æ˜¯å¦æ­£ç¡®

## ç›¸å…³æ–‡æ¡£

- `docs/deduplication_config_guide.md`: å»é‡é…ç½®å®Œæ•´æŒ‡å—
- `docs/signal_deduplication.md`: ä¿¡å·çº§åˆ«å»é‡è¯¦ç»†è¯´æ˜
